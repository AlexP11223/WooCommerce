name: PHP integration tests
on:
  push:
    branches:
      - integration-tests
jobs:
    build:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, 'ci skip')"
        continue-on-error: true
        strategy:
            fail-fast: false
            matrix:
                php-versions: ['php72', 'php73', 'php74']
        steps:
            -   uses: actions/checkout@v2

            -   name: Copy wait-for script
                uses: canastro/copy-file-action@master
                with:
                    source: "tests/docker/wait-for.sh"
                    target: "tests/docker/${{ matrix.php-versions }}/wait-for.sh"

            -   name: Run integration tests
                working-directory: ./tests/docker
                run: docker-compose run -T ${{ matrix.php-versions }} sh -c "wait-for.sh mollie-mysql:3306 -t 15 -- && composer config --global --auth http-basic.repo.packagist.com token ${{ secrets.PACKAGIST_TOKEN }} && composer install -q -n -a --no-progress --prefer-dist && composer tests:integration"

            -   uses: 8398a7/action-slack@v3
                with:
                    status: ${{ job.status }}
                    fields: message,action,commit
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
                if: failure()
